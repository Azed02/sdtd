- name: integrate argoCD
  import_tasks: argo.yaml

- name: integrate kafka
  import_tasks: kafka.yaml
  
- name: Render kafka-automation.yaml locally
  ansible.builtin.template:
    src: kafka-automation.yaml.j2
    dest: /tmp/kafka-automation.yaml
  delegate_to: localhost
  run_once: true

- name: Log first 100 lines of the rendered YAML
  ansible.builtin.shell: "head -n 100 /tmp/kafka-automation.yaml"
  delegate_to: localhost
  run_once: true
  register: rendered_yaml_head_extended

- name: Display extended rendered YAML head
  ansible.builtin.debug:
    msg: "{{ rendered_yaml_head_extended.stdout }}"
  delegate_to: localhost
  run_once: true

- name: Copy rendered YAML to control-plane
  ansible.builtin.copy:
    src: /tmp/kafka-automation.yaml
    dest: /tmp/kafka-automation.yaml
  when: inventory_hostname in groups['control-plane']

- name: Apply Kafka automation YAML on control-plane (no validation)
  ansible.builtin.shell: |
    kubectl apply --kubeconfig=/home/asmae/.kube/config --validate=false -f /tmp/kafka-automation.yaml
  when: inventory_hostname in groups['control-plane']

- name: Deploy Frontend and Backend Applications
  import_tasks: frontend-backend.yaml