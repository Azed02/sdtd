---
# Kafka Producer Pod
apiVersion: v1
kind: Pod
metadata:
  name: kafka-producer
  labels:
    app: kafka-producer
spec:
  containers:
    - name: kafka-producer-container
      image: python:3.9-slim
      command: ["/bin/bash","-c","--"]
      args:
        - >
          apt-get update && apt-get install -y gcc libatlas-base-dev &&
          pip install --no-cache-dir kafka-python google-cloud-storage matplotlib pillow &&
          mkdir -p /app &&
          cd /app &&
          echo "Running producer..." &&
          python /app/kafka_producer.py &&
          echo "Producer done. Keeping container alive." &&
          tail -f /dev/null
      volumeMounts:
        - name: producer-script-volume
          mountPath: /app/kafka_producer.py
          subPath: kafka_producer.py
  volumes:
    - name: producer-script-volume
      configMap:
        name: kafka-producer-script
  restartPolicy: Always

---
# Kafka Listener Pod
apiVersion: v1
kind: Pod
metadata:
  name: kafka-listener-1
  labels:
    app: kafka-listener-1
spec:
  containers:
    - name: kafka-listener-1-container
      image: python:3.9-slim
      command: ["/bin/bash","-c","--"]
      args:
        - >
          apt-get update && apt-get install -y gcc libatlas-base-dev &&
          pip install --no-cache-dir kafka-python google-cloud-storage matplotlib pillow &&
          mkdir -p /app &&
          cd /app &&
          echo "Running consumer #1..." &&
          python /app/kafka_consumer.py &&
          echo "Consumer #1 done. Keeping container alive." &&
          tail -f /dev/null
      volumeMounts:
        - name: consumer-script-volume
          mountPath: /app/kafka_consumer.py
          subPath: kafka_consumer.py
  volumes:
    - name: consumer-script-volume
      configMap:
        name: kafka-consumer-script
  restartPolicy: Always

---
# Kafka CLI Pod
apiVersion: v1
kind: Pod
metadata:
  name: kafka-cli
  labels:
    app: kafka-cli
spec:
  containers:
    - name: kafka-cli-container
      image: python:3.9-slim
      command: ["/bin/bash","-c","--"]
      args:
        - >
          apt-get update && apt-get install -y gcc libatlas-base-dev &&
          pip install --no-cache-dir kafka-python google-cloud-storage matplotlib pillow &&
          tail -f /dev/null
  restartPolicy: Always

---
# Kafka Producer Service
apiVersion: v1
kind: Service
metadata:
  name: kafka-producer-svc
spec:
  selector:
    app: kafka-producer
  ports:
    - name: kafka-producer-port
      protocol: TCP
      port: 8080
      targetPort: 8080
      nodePort: 30081
  type: NodePort

---
# Kafka Listener 1 Service
apiVersion: v1
kind: Service
metadata:
  name: kafka-listener-1-svc
spec:
  selector:
    app: kafka-listener-1
  ports:
    - name: listener1-port
      protocol: TCP
      port: 8080
      targetPort: 8080
      nodePort: 30082
  type: NodePort

---
# Kafka CLI Service
apiVersion: v1
kind: Service
metadata:
  name: kafka-cli-svc
spec:
  selector:
    app: kafka-cli
  ports:
    - name: kafka-cli-port
      protocol: TCP
      port: 8080
      targetPort: 8080
      nodePort: 30080
  type: NodePort
